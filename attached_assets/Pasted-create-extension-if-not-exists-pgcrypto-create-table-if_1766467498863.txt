create extension if not exists "pgcrypto";

-- 가입신청서 테이블
create table if not exists public.guest_applications (
  id                 bigserial primary key,
  created_at         timestamptz not null default now(),

  -- ✅ "해당 신청이 속한 경기 시간" (금요일 21:00 KST)
  -- 규칙:
  --   토요일~금요일 20:59:59 => "이번 주 금요일 21:00"
  --   금요일 21:00 이후(21:00:00 포함? 포함이면 여기선 포함 처리) => "다음 주 금요일 21:00"로 넘어가야 하는데
  --   너는 '경기까지 포함'이라고 했으니 금요일 21:00:00도 "이번 경기"로 묶는 것으로 처리
  game_at_kst        timestamptz not null default (
    -- 1) 현재 시간을 KST로 변환한 '현지시각'
    (
      -- 현재 KST datetime을 기준으로
      (
        -- KST 기준 "이번 주 금요일 날짜"를 계산
        (
          (now() at time zone 'Asia/Seoul')::date
          + (
              -- 금요일(5)까지 며칠 남았는지: (5 - dow + 7) % 7
              ((5 - extract(dow from (now() at time zone 'Asia/Seoul'))::int + 7) % 7)
            )
        )
        -- 금요일 21:00 붙이기
        + time '21:00'
      )
      -- 다시 timestamptz로 (KST 기준) 저장
      at time zone 'Asia/Seoul'
    )
  ),

  -- ✅ 필터링용 "경기 날짜 키" (금요일 날짜)
  game_date          date not null default (
    (
      (now() at time zone 'Asia/Seoul')::date
      + (((5 - extract(dow from (now() at time zone 'Asia/Seoul'))::int + 7) % 7))
    )::date
  ),

  -- 신청자 정보
  name               text not null,
  phone              text not null,
  age_group          text,
  height_range       text,
  positions          text,
  generated_message  text not null,

  status             text not null default 'new',
  admin_note         text,

  constraint name_len check (char_length(name) between 1 and 30),
  constraint phone_len check (char_length(phone) between 7 and 20),
  constraint msg_len check (char_length(generated_message) between 1 and 2000),
  constraint status_check check (status in ('new','checked','done'))
);

create index if not exists guest_applications_game_date_idx
  on public.guest_applications (game_date, created_at desc);

create index if not exists guest_applications_game_at_idx
  on public.guest_applications (game_at_kst);

-- 관리자 테이블
create table if not exists public.admin_users (
  user_id uuid primary key references auth.users(id) on delete cascade,
  created_at timestamptz not null default now()
);

-- RLS ON
alter table public.guest_applications enable row level security;
alter table public.admin_users enable row level security;

-- 누구나 제출 가능
drop policy if exists "Anyone can submit application" on public.guest_applications;
create policy "Anyone can submit application"
on public.guest_applications
for insert
to public
with check (true);

-- 관리자만 조회 가능
drop policy if exists "Admins can read applications" on public.guest_applications;
create policy "Admins can read applications"
on public.guest_applications
for select
to authenticated
using (
  exists (select 1 from public.admin_users a where a.user_id = auth.uid())
);

-- 관리자만 수정/삭제 가능
drop policy if exists "Admins can update applications" on public.guest_applications;
create policy "Admins can update applications"
on public.guest_applications
for update
to authenticated
using (
  exists (select 1 from public.admin_users a where a.user_id = auth.uid())
)
with check (
  exists (select 1 from public.admin_users a where a.user_id = auth.uid())
);

drop policy if exists "Admins can delete applications" on public.guest_applications;
create policy "Admins can delete applications"
on public.guest_applications
for delete
to authenticated
using (
  exists (select 1 from public.admin_users a where a.user_id = auth.uid())
);

-- admin_users도 관리자만 조회
drop policy if exists "Admins can read admin list" on public.admin_users;
create policy "Admins can read admin list"
on public.admin_users
for select
to authenticated
using (
  exists (select 1 from public.admin_users a where a.user_id = auth.uid())
);
